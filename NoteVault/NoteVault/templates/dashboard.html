<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Notes</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="dark-theme">
    <nav class="top-nav">
        <div class="nav-brand">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="#3ECFBA" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M14 2V8H20" stroke="#3ECFBA" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Secure Notes</span>
        </div>
        <div class="nav-controls">
            <button class="icon-btn" id="themeToggleBtn" title="Toggle theme">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="3" stroke="#9ca3af" stroke-width="2"/>
                    <path d="M12 1v6m0 6v6M23 12h-6m-6 0H1" stroke="#9ca3af" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="profile-wrapper">
                <button class="user-avatar" id="profileBtn" title="Profile" onclick="toggleProfileMenu()">{{ (session.user_email | trim)[:1] | upper }}</button>
                <div id="profileMenu" class="profile-menu">
                    <div class="profile-email">{{ session.user_email[:1].lower() ~ session.user_email[1:] }}</div>
                    <a href="{{ url_for('logout') }}" class="profile-logout-btn">Logout</a>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="dashboard-main">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="notes-header">
            <div>
                <h1 class="notes-title">My Notes</h1>
                <p class="notes-count">{{ notes|length }} note{% if notes|length != 1 %}s{% endif %}</p>
            </div>
            <button class="btn-new-note" onclick="toggleCreateForm()">
                <span class="plus-icon">+</span> New Note
            </button>
        </div>
        
        <div id="createNoteForm" class="create-note-form" style="display: none;">
            <form method="POST" action="{{ url_for('create_note') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <input type="text" id="title" name="title" placeholder="Note title..." required>
                </div>
                
                <div class="form-group">
                    <textarea id="content" name="content" rows="5" placeholder="Start writing..." required></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="toggleCreateForm()">Cancel</button>
                    <button type="submit" class="btn btn-save">Save Note</button>
                </div>
            </form>
        </div>
        
        <div class="notes-list">
            {% if notes %}
                {% for note in notes %}
                    <div class="note-item">
                        <div class="note-item-header">
                            <h3 class="note-item-title" id="title-view-{{ note.id }}">{{ note.title }}</h3>
                            <div class="note-menu">
                                <button class="menu-btn" onclick="toggleMenu({{ note.id }})">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                        <circle cx="12" cy="5" r="1.5" fill="#9ca3af"/>
                                        <circle cx="12" cy="12" r="1.5" fill="#9ca3af"/>
                                        <circle cx="12" cy="19" r="1.5" fill="#9ca3af"/>
                                    </svg>
                                </button>
                                <div id="menu-{{ note.id }}" class="dropdown-menu">
                                    <button type="button" class="menu-item-edit" onclick="toggleEdit({{ note.id }})">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:8px; vertical-align:middle;">
                                            <path d="M12.3 6.3l5.4 5.4M4 20l4.5-1.2L19 8.3c.4-.4.4-1 0-1.4l-1.9-1.9c-.4-.4-1-.4-1.4 0L5.2 15.5 4 20z" stroke="#3ECFBA" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Edit
                                    </button>
                                    <form method="POST" action="{{ url_for('delete_note', note_id=note.id) }}">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="menu-item-delete" onclick="return confirm('Are you sure you want to delete this note?')">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:8px; vertical-align:middle;">
                                                <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m-1 0l-1 14a2 2 0 01-2 2H10a2 2 0 01-2-2L7 6" stroke="#dc3545" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div id="edit-form-{{ note.id }}" class="edit-note-form" style="display: none;">
                            <form method="POST" action="{{ url_for('update_note', note_id=note.id) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="form-group">
                                    <input type="text" name="title" value="{{ note.title }}" required>
                                </div>
                                <div class="form-group">
                                    <textarea name="content" rows="4" required>{{ note.content }}</textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn btn-cancel" onclick="toggleEdit({{ note.id }})">Cancel</button>
                                    <button type="submit" class="btn btn-save">Save</button>
                                </div>
                            </form>
                        </div>
                        <p class="note-item-content" id="content-view-{{ note.id }}">{{ note.content }}</p>
                        <p class="note-item-date">Created {{ note.created_at }}</p>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="#374151" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M14 2V8H20" stroke="#374151" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <p>No notes yet. Click "+ New Note" to create your first note!</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <script>
        function toggleCreateForm() {
            const form = document.getElementById('createNoteForm');
            if (form.style.display === 'none') {
                form.style.display = 'block';
                document.getElementById('title').focus();
            } else {
                form.style.display = 'none';
            }
        }

        // Theme toggling
        function setTheme(theme) {
            const body = document.body;
            if (theme === 'light') {
                body.classList.remove('dark-theme');
                body.classList.add('light-theme');
            } else {
                body.classList.remove('light-theme');
                body.classList.add('dark-theme');
            }
            try { localStorage.setItem('nv_theme', theme); } catch (e) {}
        }

        function toggleTheme() {
            const isDark = document.body.classList.contains('dark-theme');
            setTheme(isDark ? 'light' : 'dark');
        }
        
        function toggleMenu(noteId) {
            const menu = document.getElementById('menu-' + noteId);
            const allMenus = document.querySelectorAll('.dropdown-menu');
            allMenus.forEach(m => {
                if (m.id !== 'menu-' + noteId) {
                    m.style.display = 'none';
                }
            });
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        
        function toggleEdit(noteId) {
            const form = document.getElementById('edit-form-' + noteId);
            const titleView = document.getElementById('title-view-' + noteId);
            const contentView = document.getElementById('content-view-' + noteId);
            const menu = document.getElementById('menu-' + noteId);

            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
                if (titleView) titleView.style.display = 'none';
                if (contentView) contentView.style.display = 'none';
            } else {
                form.style.display = 'none';
                if (titleView) titleView.style.display = '';
                if (contentView) contentView.style.display = '';
            }

            if (menu) {
                menu.style.display = 'none';
            }
        }
        
        function toggleProfileMenu() {
            const pm = document.getElementById('profileMenu');
            pm.style.display = pm.style.display === 'block' ? 'none' : 'block';
        }

        document.addEventListener('click', function(event) {
            // Close note action menus when clicking outside
            if (!event.target.closest('.note-menu')) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
            }
            // Close profile menu when clicking outside avatar/menu
            if (!event.target.closest('.profile-wrapper')) {
                const pm = document.getElementById('profileMenu');
                if (pm) pm.style.display = 'none';
            }
        });

        // Initialize theme and bind toggle button (immediately)
        (function initThemeToggle() {
            try {
                const saved = localStorage.getItem('nv_theme');
                if (saved === 'light' || saved === 'dark') {
                    setTheme(saved);
                }
            } catch (e) {}
            const btn = document.getElementById('themeToggleBtn');
            if (btn) btn.addEventListener('click', toggleTheme);
        })();

        // Auto dismiss alerts after 3 seconds
        (function initAutoDismissAlerts() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(a => {
                setTimeout(() => { if (a && a.parentNode) a.remove(); }, 3000);
            });
        })();
    </script>
</body>
</html>
